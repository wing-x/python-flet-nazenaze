import anthropic

# APIキーは環境変数に設定済み
client = anthropic.Anthropic()


# なぜなぜ分析のプロンプトテンプレート
system_prompt = "あなたは高度な問題分析スペシャリストです。ユーザーから提供される問題や状況に対して、なぜなぜ分析を行い、根本原因を特定し、適切な解決策を提案することが求められています。以下の指示に従って分析を進めてください。"

# JSON構造の定義
json_structure = """
{
  "問題": "問題の説明",
  "原因分析": [
    {"原因1": "説明"},
    {"原因2": "説明"},
    // ... 他の原因
  ],
  "対策案": [
    {"対策1": "説明"},
    {"対策2": "説明"},
    // ... 他の対策
  ],
  "まとめ": "総括"
}
"""

human_prompt = """以下の問題についてなぜなぜ分析を行ってください：

{user_input}

分析を以下の手順で進めてください：

1. 問題の明確化：提示された問題を簡潔に要約し、分析の焦点を定めてください。

2. 5つの「なぜ」：問題の根本原因を探るため、5回の「なぜ」を使用してください。各段階で理由を説明し、可能な限り具体例を挙げてください。

3. 多角的視点：技術的、人的、プロセス的な観点から問題を分析してください。

4. 仮説の提示：各段階で複数の仮説を提示し、それぞれの妥当性を評価してください。

5. 相互関係の考慮：特定された要因間の相互関係や影響を考慮してください。

6. 根本原因の特定：分析結果に基づいて、最も可能性の高い根本原因を特定してください。

7. 対策案の提案：特定された根本原因に対する3〜5つの具体的な対策案を提案してください。各対策案の実現可能性と期待される効果も簡潔に説明してください。

8. 限界と追加調査：この分析で確実に言えることと、さらなる調査が必要な点を明確に区別してください。

9. まとめ：分析全体を簡潔にまとめ、主要な発見と推奨される次のステップを提示してください。

専門用語を使用する場合は、必要に応じて簡単な説明を加えてください。

回答はJSON形式で提供してください。以下の構造を使用してください：
{json_structure}
"""

# 回答は明確に構造化し、各セクションに見出しをつけてください。


def perform_naze_naze_analysis(user_input, model):
    # ユーザー入力をプロンプトに挿入
    formatted_human_prompt = human_prompt.format(user_input=user_input, json_structure=json_structure)

    message = client.messages.create(
        model=model,
        max_tokens=4000,
        temperature=0,
        system=system_prompt,
        messages=[
            {"role": "user", "content": formatted_human_prompt},
            {
                "role": "assistant",
                "content": "承知しました。提供された問題に対してなぜなぜ分析を行い、指示された手順に従って詳細な分析と提案を行います。",
            },
            {"role": "user", "content": "では、分析を始めてください。解答は日本語でお願いします"},
        ],
    )
    return message.content
